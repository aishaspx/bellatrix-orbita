<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bellatrix | Orbital Intelligence Platform</title>

    <!-- Meta Tags -->
    <meta name="description" content="AI-powered satellite risk monitoring and orbital analytics.">
    <meta name="theme-color" content="#05070a">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap"
        rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="style.css">

    <!-- Libraries (CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
</head>

<body style="margin: 0; padding: 0; background-color: #020204; color: #ffffff; font-family: 'Inter', sans-serif;">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8000/api'
            : '/api';

        // --- Robust API Fetch Helper with Retry ---
        async function fetchWithRetry(url, options = {}, maxRetries = 3, timeout = 10000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    
                    // Check if response is ok
                    if (!response.ok) {
                        if (response.status >= 500 && attempt < maxRetries - 1) {
                            // Retry on server errors
                            await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
                            continue;
                        }
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    // Try to parse JSON, but handle non-JSON responses
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return await response.json();
                    } else {
                        return await response.text();
                    }
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error('Request timeout');
                    }
                    if (attempt === maxRetries - 1) {
                        throw error;
                    }
                    // Wait before retry (exponential backoff)
                    await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
                }
            }
        }

        // --- TRANSLATIONS ---
        const TRANSLATIONS = {
            en: {
                nav_home: "Home", nav_calc: "Calculator", nav_guide: "Guide", nav_map: "Live Map", nav_forecast: "AI Forecast",
                home_sub: "AI-powered orbital risk intelligence platform. Visualize complex satellite trajectories, analyze collision probabilities, and master the orbital mechanics of tomorrow.",
                start_btn: "Start Analysis",
                mission_title: "Orbital Integrity",
                mission_txt: "Low Earth Orbit is becoming dangerously crowded. With over 27,000 tracked objects, the risk of Kessler Syndrome‚Äîa cascade of collisions‚Äîis real. Bellatrix provides the intelligence needed to navigate this new frontier safely.",
                calc_add: "Add Satellite",
                calc_placeholder: "NORAD ID or Name",
                footer_data: "Data: NASA, ESA, SpaceX, CelesTrak, & NORAD APIs.",
                about_title: "Orbital Mechanics",
                guide_title: "User Manual",
                guide_1_t: "1. Select a Satellite",
                guide_1_d: "Search in the Calculator tab using NORAD ID (e.g., 25544) or name.",
                guide_2_t: "2. View Telemetry",
                guide_2_d: "Analyze inclination, period, and real-time altitude in the detail panel.",
                guide_3_t: "3. Analyze Risk",
                guide_3_d: "Monitor collision probabilities and AI stability forecasts.",
                calc_init: "Initializing Uplink...",
                calc_select: "Select a satellite to begin analysis",
                detail_title: "Telemetry Analysis",
                lbl_alt: "Altitude", lbl_vel: "Velocity", lbl_inc: "Inclination", lbl_per: "Period", lbl_apo: "Apogee", lbl_peri: "Perigee",
                lbl_lat: "Latitude", lbl_lon: "Longitude",
                leo_t: "LEO: The Cosmic Highway",
                leo_d: "Low Earth Orbit (160-2000 km). Home to the ISS. High velocity (~7.8 km/s).",
                meo_t: "MEO: Navigation Zone",
                meo_d: "Medium Earth Orbit. Home to GPS constellations.",
                geo_t: "GEO: Tracking Point",
                geo_d: "Geostationary Orbit. Appears fixed relative to Earth.",
                ks_t: "Kessler Syndrome",
                ks_d: "A collision cascade that could create an impassable debris belt.",
                stem_title: "Empowering Exploration",
                stem_sub: "Bridging the gap between tracking data and orbital science.",
                target_1_t: "Educators",
                target_1_d: "Visualize Keplerian physics in dynamic 3D.",
                target_2_t: "Researchers",
                target_2_d: "Analyze risk and conjunction probability.",
                target_3_t: "Enthusiasts",
                target_3_d: "Track ISS and global mega-constellations.",
                why_stem_t: "Science & Intelligence",
                why_stem_d: "Unifying Physics, AI, and Big Data.",

                // New Keys
                f_title: "AI Intelligence Forecast",
                f_risk_trend: "Satellite Risk Trend",
                f_neural_summary: "Neural Forecast Summary",
                f_stability: "Stability Index",
                f_avg_alt: "Avg Altitude",
                f_empty: "Select a satellite in Calculator to view AI trends",

                m_title: "Global Ground Track",
                m_tracking: "Tracking",
                m_intel: "Intelligence Overlay",
                m_obj: "Objects Tracked",
                m_risk: "High Risk",
                m_status: "Status",
                m_status_update: "Last Update",
                m_op: "Operational",
                m_calc: "Calculating Path...",

                s_nav: "Navigation",
                s_intel: "Intelligence",
                s_legal: "Legal & Data",
                s_platform: "Autonomous Orbital Intelligence Platform",
                s_terms: "API Terms",
                s_policy: "Data Policy",
                s_calc: "Calculator (Tracking)",
                s_map: "World Map (Visualizer)",
                s_forecast: "AI Forecast (Analytics)",
                s_guide: "User Guide",
                s_prop: "Orbital Propagation",
                s_risk: "Risk Assessment",
                s_ground: "Ground Track Analysis",
                s_ready: "Sector Readiness",

                err_title: "System Malfunction",
                err_msg: "An unexpected error occurred in this module.",
                err_btn: "Reboot System",
                err_not_found: "Object not found.",
                err_search_fail: "Search failed.",
                err_details_fail: "Error retrieving satellite details.",

                g_how: "How to Use Bellatrix",
                g_step1_t: "1. Search & Select",
                g_step1_d: "Go to the Calculator tab. Use the search bar to find satellites by NORAD ID (e.g., '25544' for ISS) or Name. Click 'Add' to track them.",
                g_step2_t: "2. Analyze Risk",
                g_step2_d: "Select a satellite from your dashboard. The 'Telemetry Analysis' panel shows real-time data. Look for the Risk Probability field. If it exceeds 1%, a Warning Alert will appear.",
                g_step3_t: "3. Visualize",
                g_step3_d: "Use the Map button in the detail panel to see the satellite's current position over Earth. The 3D view shows its orbital path relative to the planet.",
                g_term: "Terminology",
                g_per_d: "Time to complete one orbit (e.g., ISS takes ~92 mins).",
                g_inc_d: "Angle of the orbit relative to the equator. 0¬∞ = Equatorial, 90¬∞ = Polar.",
                g_apo_per_d: "The highest (Apogee) and lowest (Perigee) points of the orbit.",
                g_ks_d: "A chain reaction of collisions destroying the orbital environment.",

                det_warn: "COLLISION WARNING",
                det_prob: "Prob",
                det_dist: "Dist",
                det_time: "Time",

                g_copyright_title: "Copyright & Rights",
                g_copyright_text: "¬© 2026 Bellatrix Orbita Project. All rights reserved. Data provided by NORAD, NASA, SpaceX and CelesTrak. This platform is for educational and research purposes. All orbital visualizations are generated in real-time based on public TLE data.",

                btn_map: "Map",
                btn_csv: "CSV",
                btn_pdf: "PDF",
                btn_clear: "Clear History"
            },
            ru: {
                nav_home: "–ì–ª–∞–≤–Ω–∞—è", nav_calc: "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä", nav_guide: "–°–ø—Ä–∞–≤–∫–∞", nav_map: "–ö–∞—Ä—Ç–∞", nav_forecast: "AI –ü—Ä–æ–≥–Ω–æ–∑",
                home_sub: "–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –æ—Ä–±–∏—Ç–∞–ª—å–Ω–æ–π —Ä–∞–∑–≤–µ–¥–∫–∏ –Ω–∞ –±–∞–∑–µ –ò–ò. –í–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ —Å–ø—É—Ç–Ω–∏–∫–æ–≤, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π –∏ –∏–∑—É—á–∞–π—Ç–µ –æ—Ä–±–∏—Ç–∞–ª—å–Ω—É—é –º–µ—Ö–∞–Ω–∏–∫—É –±—É–¥—É—â–µ–≥–æ.",
                start_btn: "–ù–∞—á–∞—Ç—å –ê–Ω–∞–ª–∏–∑",
                mission_title: "–û—Ä–±–∏—Ç–∞–ª—å–Ω–∞—è –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å",
                mission_txt: "–ù–∏–∑–∫–∞—è –æ–∫–æ–ª–æ–∑–µ–º–Ω–∞—è –æ—Ä–±–∏—Ç–∞ –æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –±–æ–ª–µ–µ 27 000 –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ —Ä–∏—Å–∫ –°–∏–Ω–¥—Ä–æ–º–∞ –ö–µ—Å—Å–ª–µ—Ä–∞ ‚Äî –∫–∞—Å–∫–∞–¥–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π ‚Äî –≤–ø–æ–ª–Ω–µ —Ä–µ–∞–ª–µ–Ω. Bellatrix –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–∞–∑–≤–µ–¥–¥–∞–Ω–Ω—ã–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤ —ç—Ç–æ–º –Ω–æ–≤–æ–º —Ñ—Ä–æ–Ω—Ç–∏—Ä–µ.",
                calc_add: "–î–æ–±–∞–≤–∏—Ç—å",
                calc_placeholder: "NORAD ID –∏–ª–∏ –ò–º—è",
                footer_data: "–î–∞–Ω–Ω—ã–µ: NASA, ESA, SpaceX, CelesTrak –∏ API NORAD.",
                about_title: "–û—Ä–±–∏—Ç–∞–ª—å–Ω–∞—è –ú–µ—Ö–∞–Ω–∏–∫–∞",
                guide_title: "–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
                guide_1_t: "1. –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø—É—Ç–Ω–∏–∫",
                guide_1_d: "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –≤ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ –ø–æ NORAD ID (–Ω–∞–ø—Ä. 25544) –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é.",
                guide_2_t: "2. –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏",
                guide_2_d: "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –Ω–∞–∫–ª–æ–Ω–µ–Ω–∏–µ, –ø–µ—Ä–∏–æ–¥ –∏ –≤—ã—Å–æ—Ç—É –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –ø–∞–Ω–µ–ª–∏ –¥–µ—Ç–∞–ª–µ–π.",
                guide_3_t: "3. –ê–Ω–∞–ª–∏–∑ —Ä–∏—Å–∫–æ–≤",
                guide_3_d: "–°–ª–µ–¥–∏—Ç–µ –∑–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è –∏ –ø—Ä–æ–≥–Ω–æ–∑–∞–º–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç –ò–ò.",
                calc_init: "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–≤—è–∑–∏...",
                calc_select: "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø—É—Ç–Ω–∏–∫ –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏–∑–∞",
                detail_title: "–ê–Ω–∞–ª–∏–∑ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏",
                lbl_alt: "–í—ã—Å–æ—Ç–∞", lbl_vel: "–°–∫–æ—Ä–æ—Å—Ç—å", lbl_inc: "–ù–∞–∫–ª–æ–Ω–µ–Ω–∏–µ", lbl_per: "–ü–µ—Ä–∏–æ–¥", lbl_apo: "–ê–ø–æ–≥–µ–π", lbl_peri: "–ü–µ—Ä–∏–≥–µ–π",
                lbl_lat: "–®–∏—Ä–æ—Ç–∞", lbl_lon: "–î–æ–ª–≥–æ—Ç–∞",
                leo_t: "LEO: –ö–æ—Å–º–∏—á–µ—Å–∫–æ–µ —à–æ—Å—Å–µ",
                leo_d: "–ù–∏–∑–∫–∞—è –æ–∫–æ–ª–æ–∑–µ–º–Ω–∞—è –æ—Ä–±–∏—Ç–∞ (160-2000 –∫–º). –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ú–ö–°. –í—ã—Å–æ–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (~7.8 –∫–º/—Å).",
                meo_t: "MEO: –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –∑–æ–Ω–∞",
                meo_d: "–°—Ä–µ–¥–Ω—è—è –æ–∫–æ–ª–æ–∑–µ–º–Ω–∞—è –æ—Ä–±–∏—Ç–∞. –ó–¥–µ—Å—å –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ GPS.",
                geo_t: "GEO: –¢–æ—á–∫–∞ —Å–ª–µ–∂–µ–Ω–∏—è",
                geo_d: "–ì–µ–æ—Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω–∞—è –æ—Ä–±–∏—Ç–∞. –ö–∞–∂–µ—Ç—Å—è –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ó–µ–º–ª–∏.",
                ks_t: "–°–∏–Ω–¥—Ä–æ–º –ö–µ—Å—Å–ª–µ—Ä–∞",
                ks_d: "–¶–µ–ø–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π, —Å–ø–æ—Å–æ–±–Ω–∞—è —Å–æ–∑–¥–∞—Ç—å –Ω–µ–ø—Ä–æ—Ö–æ–¥–∏–º—ã–π –ø–æ—è—Å –æ–±–ª–æ–º–∫–æ–≤.",
                stem_title: "–†–∞—Å—à–∏—Ä—è—è –≥—Ä–∞–Ω–∏—Ü—ã",
                stem_sub: "–û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å–ª–µ–∂–µ–Ω–∏—è –∏ –æ—Ä–±–∏—Ç–∞–ª—å–Ω—É—é –Ω–∞—É–∫—É.",
                target_1_t: "–î–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π",
                target_1_d: "–í–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∑–∞–∫–æ–Ω—ã –ö–µ–ø–ª–µ—Ä–∞ –≤ –¥–∏–Ω–∞–º–∏—á–Ω–æ–º 3D.",
                target_2_t: "–î–ª—è —É—á–µ–Ω—ã—Ö",
                target_2_d: "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–∏—Å–∫–∏ –∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —Å–±–ª–∏–∂–µ–Ω–∏–π.",
                target_3_t: "–î–ª—è —ç–Ω—Ç—É–∑–∏–∞—Å—Ç–æ–≤",
                target_3_d: "–°–ª–µ–¥–∏—Ç–µ –∑–∞ –ú–ö–° –∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –º–µ–≥–∞-–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞–º–∏.",
                why_stem_t: "–ù–∞—É–∫–∞ –∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç",
                why_stem_d: "–°–∏–Ω—Ç–µ–∑ —Ñ–∏–∑–∏–∫–∏, –ò–ò –∏ –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö.",

                // New Keys
                f_title: "–ü—Ä–æ–≥–Ω–æ–∑ –ò–ò-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏",
                f_risk_trend: "–¢—Ä–µ–Ω–¥ —Ä–∏—Å–∫–∞ —Å–ø—É—Ç–Ω–∏–∫–∞",
                f_neural_summary: "–ù–µ–π—Ä–æ–Ω–Ω–∞—è —Å–≤–æ–¥–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞",
                f_stability: "–ò–Ω–¥–µ–∫—Å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏",
                f_avg_alt: "–°—Ä–µ–¥–Ω—è—è –≤—ã—Å–æ—Ç–∞",
                f_empty: "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø—É—Ç–Ω–∏–∫ –≤ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç—Ä–µ–Ω–¥–æ–≤ –ò–ò",

                m_title: "–ì–ª–æ–±–∞–ª—å–Ω–∞—è –Ω–∞–∑–µ–º–Ω–∞—è —Ç—Ä–∞—Å—Å–∞",
                m_tracking: "–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ",
                m_intel: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–ª–æ–π",
                m_obj: "–û–±—ä–µ–∫—Ç–æ–≤ –æ—Ç—Å–ª–µ–∂–µ–Ω–æ",
                m_risk: "–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫",
                m_status: "–°—Ç–∞—Ç—É—Å",
                m_status_update: "–û–±–Ω–æ–≤–ª–µ–Ω–æ",
                m_op: "–í —Ä–∞–±–æ—Ç–µ",
                m_calc: "–†–∞—Å—á–µ—Ç —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏...",

                s_nav: "–ù–∞–≤–∏–≥–∞—Ü–∏—è",
                s_intel: "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞",
                s_legal: "–î–∞–Ω–Ω—ã–µ –∏ –ø—Ä–∞–≤–æ",
                s_platform: "–ê–≤—Ç–æ–Ω–æ–º–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –æ—Ä–±–∏—Ç–∞–ª—å–Ω–æ–π —Ä–∞–∑–≤–µ–¥–∫–∏",
                s_terms: "–£—Å–ª–æ–≤–∏—è API",
                s_policy: "–ü–æ–ª–∏—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö",
                s_calc: "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä (–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)",
                s_map: "–ö–∞—Ä—Ç–∞ –º–∏—Ä–∞ (–í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä)",
                s_forecast: "AI –ü—Ä–æ–≥–Ω–æ–∑ (–ê–Ω–∞–ª–∏—Ç–∏–∫–∞)",
                s_guide: "–°–ø—Ä–∞–≤–∫–∞",
                s_prop: "–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ä–±–∏—Ç",
                s_risk: "–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤",
                s_ground: "–ê–Ω–∞–ª–∏–∑ –Ω–∞–∑–µ–º–Ω–æ–π —Ç—Ä–∞—Å—Å—ã",
                s_ready: "–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —Å–µ–∫—Ç–æ—Ä–∞",

                err_title: "–°–±–æ–π —Å–∏—Å—Ç–µ–º—ã",
                err_msg: "–í —ç—Ç–æ–º –º–æ–¥—É–ª–µ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞.",
                err_btn: "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã",
                err_not_found: "–û–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.",
                err_search_fail: "–°–±–æ–π –ø–æ–∏—Å–∫–∞.",
                err_details_fail: "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å–ø—É—Ç–Ω–∏–∫–∞.",

                g_how: "–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è Bellatrix",
                g_step1_t: "1. –ü–æ–∏—Å–∫ –∏ –≤—ã–±–æ—Ä",
                g_step1_d: "–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –ø–æ NORAD ID (–Ω–∞–ø—Ä–∏–º–µ—Ä, '25544' –¥–ª—è –ú–ö–°) –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é. –ù–∞–∂–º–∏—Ç–µ '–î–æ–±–∞–≤–∏—Ç—å' –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è.",
                g_step2_t: "2. –ê–Ω–∞–ª–∏–∑ —Ä–∏—Å–∫–æ–≤",
                g_step2_d: "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø—É—Ç–Ω–∏–∫ –∏–∑ —Å–ø–∏—Å–∫–∞. –ü–∞–Ω–µ–ª—å '–ê–Ω–∞–ª–∏–∑ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏' –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø–æ–ª–µ '–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è'. –ï—Å–ª–∏ –æ–Ω–∞ –≤—ã—à–µ 1%, –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ.",
                g_step3_t: "3. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è",
                g_step3_d: "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–ö–∞—Ä—Ç–∞' –≤ –¥–µ—Ç–∞–ª—è—Ö, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ç–µ–∫—É—â–µ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ. 3D-–≤–∏–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ä–±–∏—Ç–∞–ª—å–Ω—ã–π –ø—É—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø–ª–∞–Ω–µ—Ç—ã.",
                g_term: "–¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è",
                g_per_d: "–í—Ä–µ–º—è –ø–æ–ª–Ω–æ–≥–æ –æ–±–æ—Ä–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ú–ö–° ‚Äî –æ–∫–æ–ª–æ 92 –º–∏–Ω—É—Ç).",
                g_inc_d: "–£–≥–æ–ª –æ—Ä–±–∏—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —ç–∫–≤–∞—Ç–æ—Ä–∞. 0¬∞ ‚Äî —ç–∫–≤–∞—Ç–æ—Ä–∏–∞–ª—å–Ω–∞—è, 90¬∞ ‚Äî –ø–æ–ª—è—Ä–Ω–∞—è.",
                g_apo_per_d: "–°–∞–º–∞—è –≤—ã—Å–æ–∫–∞—è (–∞–ø–æ–≥–µ–π) –∏ —Å–∞–º–∞—è –Ω–∏–∑–∫–∞—è (–ø–µ—Ä–∏–≥–µ–π) —Ç–æ—á–∫–∏ –æ—Ä–±–∏—Ç—ã.",
                g_ks_d: "–¶–µ–ø–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π, —Ä–∞–∑—Ä—É—à–∞—é—â–∞—è –æ—Ä–±–∏—Ç–∞–ª—å–Ω—É—é —Å—Ä–µ–¥—É.",

                g_copyright_title: "–ê–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–∞–≤–∞",
                g_copyright_text: "¬© 2026 –ü—Ä–æ–µ–∫—Ç Bellatrix Orbita. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã. –î–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã NORAD, NASA, SpaceX –∏ CelesTrak. –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ü–µ–ª–µ–π. –í—Å–µ –æ—Ä–±–∏—Ç–∞–ª—å–Ω—ã–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö TLE.",

                det_warn: "–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï –û –°–ë–õ–ò–ñ–ï–ù–ò–ò",
                det_prob: "–í–µ—Ä-—Ç—å",
                det_dist: "–î–∏—Å—Ç",
                det_time: "–í—Ä–µ–º—è",

                btn_map: "–ö–∞—Ä—Ç–∞",
                btn_csv: "CSV",
                btn_pdf: "PDF",
                btn_clear: "–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é"
            }
        };

        // --- COMPONENTS ---

        // Toast Notification Component
        function Toast({ message, type = 'error', onClose, index = 0 }) {
            const colors = {
                error: { bg: 'rgba(255, 0, 85, 0.15)', border: '#ff0055', text: '#ffcccb' },
                success: { bg: 'rgba(0, 255, 136, 0.15)', border: '#00ff88', text: '#b3ffdd' },
                info: { bg: 'rgba(0, 243, 255, 0.15)', border: '#00f3ff', text: '#b3ffff' }
            };
            const style = colors[type] || colors.error;

            return (
                <div style={{
                    position: 'fixed', top: `${20 + index * 80}px`, right: '20px', zIndex: 10000,
                    background: style.bg, border: `1px solid ${style.border}`, borderRadius: '8px',
                    padding: '1rem 1.5rem', minWidth: '300px', maxWidth: '500px',
                    boxShadow: '0 4px 20px rgba(0,0,0,0.5)',
                    display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: '1rem',
                    animation: 'slideIn 0.3s ease-out'
                }}>
                    <span style={{ color: style.text, flex: 1 }}>{message}</span>
                    <button onClick={onClose} style={{
                        background: 'transparent', border: 'none', color: style.text,
                        cursor: 'pointer', fontSize: '1.2rem', padding: '0', width: '24px', height: '24px'
                    }}>√ó</button>
                    <style>{`
                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                    `}</style>
                </div>
            );
        }

        // Toast Manager Hook
        function useToast() {
            const [toasts, setToasts] = useState([]);

            const showToast = (message, type = 'error') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 5000);
            };

            const ToastContainer = () => (
                <React.Fragment>
                    {toasts.map((toast, index) => (
                        <Toast
                            key={toast.id}
                            message={toast.message}
                            type={toast.type}
                            index={index}
                            onClose={() => setToasts(prev => prev.filter(t => t.id !== toast.id))}
                        />
                    ))}
                </React.Fragment>
            );

            return [showToast, ToastContainer];
        }

        // Error Boundary to prevent "Black Screens" by catching render errors in sub-components
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error("Uncaught error:", error, errorInfo);
            }

            render() {
                // Pass current language to error boundary implicitly or via props if needed
                // For simplicity, we'll use a default or window level lang if available
                const lang = window.appLang || 'en';
                const t = TRANSLATIONS[lang] || TRANSLATIONS.en;

                if (this.state.hasError) {
                    return (
                        <div style={{ padding: '2rem', color: '#ff0055', textAlign: 'center', background: 'rgba(0,0,0,0.8)', margin: '2rem', borderRadius: '8px', border: '1px solid #ff0055' }}>
                            <h2 style={{ fontFamily: 'Cinzel' }}>{t.err_title}</h2>
                            <p>{t.err_msg}</p>
                            <pre style={{ textAlign: 'left', background: '#111', padding: '1rem', overflow: 'auto', fontSize: '0.8rem', color: '#ffcccb' }}>
                                {this.state.error && this.state.error.toString()}
                            </pre>
                            <button className="cta-button" onClick={() => window.location.reload()}>{t.err_btn}</button>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        function BellatrixLogo() {
            return (
                <div style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}>
                    <svg width="32" height="32" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="50" cy="50" r="40" stroke="url(#grad1)" strokeWidth="4" />
                        <ellipse cx="50" cy="50" rx="45" ry="15" transform="rotate(25 50 50)" stroke="url(#grad2)" strokeWidth="2" strokeOpacity="0.8" />
                        <path d="M50 20L58 42L82 42L62 58L70 80L50 65L30 80L38 58L18 42L42 42L50 20Z" fill="white" />
                        <defs>
                            <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop stopColor="#bc13fe" />
                                <stop offset="1" stopColor="#05070a" />
                            </linearGradient>
                            <linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop stopColor="#4facfe" />
                                <stop offset="1" stopColor="#00f2fe" />
                            </linearGradient>
                        </defs>
                    </svg>
                    <span style={{ fontFamily: 'Cinzel', fontSize: '1.5rem', fontWeight: '700', letterSpacing: '2px', background: 'linear-gradient(to right, #fff, #aaa)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
                        BELLATRIX
                    </span>
                </div>
            );
        }

        function StarBackground() {
            const canvasRef = useRef(null);
            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let width = window.innerWidth; let height = window.innerHeight;
                canvas.width = width; canvas.height = height;
                const stars = [];
                for (let i = 0; i < 300; i++) stars.push({ x: Math.random() * width, y: Math.random() * height, size: Math.random() * 2, speed: Math.random() * 0.3, color: Math.random() > 0.8 ? '#bc13fe' : '#ffffff' });
                function animate() {
                    ctx.clearRect(0, 0, width, height);
                    stars.forEach(star => {
                        ctx.beginPath(); ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2); ctx.fillStyle = star.color; ctx.fill();
                        star.y -= star.speed; if (star.y < 0) { star.y = height; star.x = Math.random() * width; }
                    });
                    requestAnimationFrame(animate);
                }
                animate();
                window.addEventListener('resize', () => { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; });
            }, []);
            return <canvas id="star-canvas" ref={canvasRef} />;
        }

        function NavBar({ currentView, setView, lang, setLang }) {
            const t = TRANSLATIONS[lang];
            return (
                <nav className="nav-bar">
                    <div onClick={() => setView('home')}>
                        <BellatrixLogo />
                    </div>
                    <div className="nav-right">
                        <div className="nav-links">
                            <div className={`nav-item ${currentView === 'home' ? 'active' : ''}`} onClick={() => setView('home')}>{t.nav_home}</div>
                            <div className={`nav-item ${currentView === 'guide' ? 'active' : ''}`} onClick={() => setView('guide')}>{t.nav_guide}</div>
                            <div className={`nav-item ${currentView === 'map' ? 'active' : ''}`} onClick={() => setView('map')}>{t.nav_map}</div>
                            <div className={`nav-item ${currentView === 'forecast' ? 'active' : ''}`} onClick={() => setView('forecast')}>{t.nav_forecast}</div>
                            <div className={`nav-item ${currentView === 'calc' ? 'active' : ''}`} onClick={() => setView('calc')}>{t.nav_calc}</div>
                        </div>
                        <div className="lang-switch">
                            <div className={`lang-opt ${lang === 'en' ? 'active' : ''}`} onClick={() => setLang('en')}>EN</div>
                            <div className={`lang-opt ${lang === 'ru' ? 'active' : ''}`} onClick={() => setLang('ru')}>RU</div>
                        </div>
                    </div>
                </nav>
            );
        }

        function HomeView({ setView, t }) {
            return (
                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                    <div className="section-container hero-section">
                        <div style={{ transform: 'scale(1.5)', marginBottom: '1rem' }}><BellatrixLogo /></div>
                        <p className="hero-subtitle">{t.home_sub}</p>
                        <button className="cta-button" onClick={() => setView('calc')}>{t.start_btn}</button>

                        <div style={{ marginTop: '4rem', maxWidth: '800px', textAlign: 'left', background: 'rgba(255,255,255,0.05)', padding: '2rem', borderRadius: '12px' }}>
                            <h3 style={{ fontFamily: 'Cinzel', color: 'var(--primary-glow)' }}>{t.mission_title}</h3>
                            <p style={{ color: '#ccc', lineHeight: '1.6' }}>{t.mission_txt}</p>
                            <hr style={{ borderColor: 'rgba(255,255,255,0.1)', margin: '1rem 0' }} />
                            <small style={{ color: '#666' }}>Project Bellatrix &copy; 2026. {t.footer_data}</small>
                        </div>
                    </div>

                    <div className="section-container" style={{ background: 'linear-gradient(180deg, rgba(20,30,50,0.5) 0%, rgba(5,7,10,0) 100%)', marginTop: '2rem' }}>
                        <h2 style={{ fontFamily: 'Cinzel', color: 'white' }}>{t.stem_title}</h2>
                        <p style={{ color: '#aaa', marginBottom: '2rem' }}>{t.stem_sub}</p>

                        <div className="info-grid">
                            <div className="info-card" style={{ borderColor: '#00f3ff' }}>
                                <h3 style={{ color: '#00f3ff' }}>üéì {t.target_1_t}</h3>
                                <p style={{ color: '#ccc' }}>{t.target_1_d}</p>
                            </div>
                            <div className="info-card" style={{ borderColor: '#bc13fe' }}>
                                <h3 style={{ color: '#bc13fe' }}>üî¨ {t.target_2_t}</h3>
                                <p style={{ color: '#ccc' }}>{t.target_2_d}</p>
                            </div>
                            <div className="info-card" style={{ borderColor: '#ffaa00' }}>
                                <h3 style={{ color: '#ffaa00' }}>üî≠ {t.target_3_t}</h3>
                                <p style={{ color: '#ccc' }}>{t.target_3_d}</p>
                            </div>
                        </div>

                        <div style={{ marginTop: '2rem', padding: '1.5rem', border: '1px solid #444', borderRadius: '12px', background: 'rgba(255,255,255,0.02)' }}>
                            <h3 style={{ fontFamily: 'Cinzel', color: 'white' }}>‚öõÔ∏è {t.why_stem_t}</h3>
                            <p style={{ color: '#ccc', fontStyle: 'italic' }}>{t.why_stem_d}</p>
                        </div>
                    </div>

                    <div className="section-container">
                        <h2 style={{ fontFamily: 'Cinzel', color: 'white' }}>{t.about_title}</h2>
                        <div className="info-grid">
                            <div className="info-card"><h3>{t.leo_t}</h3><p style={{ color: '#aaa' }}>{t.leo_d}</p></div>
                            <div className="info-card"><h3>{t.meo_t}</h3><p style={{ color: '#aaa' }}>{t.meo_d}</p></div>
                            <div className="info-card"><h3>{t.geo_t}</h3><p style={{ color: '#aaa' }}>{t.geo_d}</p></div>
                            <div className="info-card"><h3>{t.ks_t}</h3><p style={{ color: '#aaa' }}>{t.ks_d}</p></div>
                        </div>
                    </div>
                </div >
            );
        }

        function GuideView({ t }) {
            return (
                <div className="section-container" style={{ maxWidth: '800px' }}>
                    <h2 style={{ fontFamily: 'Cinzel', color: 'white' }}>{t.guide_title}</h2>

                    <div style={{ marginBottom: '2rem' }}>
                        <h3 style={{ color: '#00f3ff', borderBottom: '1px solid #333', paddingBottom: '0.5rem' }}>{t.g_how}</h3>
                        <div className="guide-step">
                            <h4>{t.g_step1_t}</h4>
                            <p style={{ color: '#ccc' }}>{t.g_step1_d}</p>
                        </div>
                        <div className="guide-step">
                            <h4>{t.g_step2_t}</h4>
                            <p style={{ color: '#ccc' }}>{t.g_step2_d}</p>
                        </div>
                        <div className="guide-step">
                            <h4>{t.g_step3_t}</h4>
                            <p style={{ color: '#ccc' }}>{t.g_step3_d}</p>
                        </div>
                    </div>

                    <div style={{ marginBottom: '2rem' }}>
                        <h3 style={{ color: '#bc13fe', borderBottom: '1px solid #333', paddingBottom: '0.5rem' }}>{t.g_term}</h3>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                            <div>
                                <h5 style={{ color: '#fff' }}>{t.lbl_per}</h5>
                                <p style={{ fontSize: '0.9rem', color: '#aaa' }}>{t.g_per_d}</p>
                            </div>
                            <div>
                                <h5 style={{ color: '#fff' }}>{t.lbl_inc}</h5>
                                <p style={{ fontSize: '0.9rem', color: '#aaa' }}>{t.g_inc_d}</p>
                            </div>
                            <div>
                                <h5 style={{ color: '#fff' }}>{t.lbl_apo} / {t.lbl_peri}</h5>
                                <p style={{ fontSize: '0.9rem', color: '#aaa' }}>{t.g_apo_per_d}</p>
                            </div>
                            <div>
                                <h5 style={{ color: '#fff' }}>{t.ks_t}</h5>
                                <p style={{ fontSize: '0.9rem', color: '#aaa' }}>{t.g_ks_d}</p>
                            </div>
                        </div>
                    </div>

                    <div style={{ marginTop: '3rem', paddingTop: '1rem', borderTop: '1px solid #222', color: '#555', fontSize: '0.8rem' }}>
                        <h4 style={{ color: '#888', marginBottom: '0.5rem' }}>{t.g_copyright_title}</h4>
                        <p>{t.g_copyright_text}</p>
                    </div>
                </div>
            );
        }

        function SatelliteCard({ sat, onClick, t }) {
            // Normalize risk level to Title Case for CSS consistency
            const riskClass = sat.risk_level
                ? sat.risk_level.charAt(0).toUpperCase() + sat.risk_level.slice(1).toLowerCase()
                : 'Safe';

            // Risk Badge Color Map
            const riskColors = {
                'Safe': '#00ff88',
                'Low': '#00f3ff',
                'Medium': '#ffaa00',
                'High': '#ff0055'
            };
            const badgeColor = riskColors[riskClass] || '#00ff88';

            return (
                <div className={`sat-card risk-${riskClass}`} onClick={() => onClick(sat)} style={{ borderLeft: `4px solid ${badgeColor}` }}>
                    <div className="card-header">
                        <span className="sat-name">{sat.name}</span>
                        <span className="sat-type" style={{ backgroundColor: badgeColor, color: '#000', fontWeight: 'bold' }}>{riskClass.toUpperCase()}</span>
                    </div>
                    <div className="card-metrics">
                        <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                            <span className="sat-type">{sat.orbit_type}</span>
                            <span>{sat.altitude_km} km</span>
                            <span style={{ fontSize: '0.7rem', color: '#888', marginLeft: 'auto' }}>{sat.data_source}</span>
                        </div>
                    </div>
                </div>
            );
        }

        function DetailPanel({ sat, t, onShowMap }) {
            if (!sat) return <div className="detail-panel" style={{ justifyContent: 'center', alignItems: 'center', opacity: 0.5 }}><h3>{t.calc_select}</h3></div>;

            // Risk Warning Logic
            const showWarning = sat.collision_probability > 1.0;
            const warningColor = '#ff0055';

            return (
                <div className="detail-panel">
                    <div className="detail-header">
                        {t.detail_title}: {sat.name}
                        <div style={{ marginLeft: 'auto', display: 'flex', gap: '0.5rem' }}>
                            {/* Show on Map Button */}
                            <button onClick={onShowMap} style={{
                                background: 'transparent',
                                border: '1px solid #00f3ff', color: '#00f3ff',
                                padding: '4px 8px', borderRadius: '4px', cursor: 'pointer', fontSize: '0.8rem'
                            }}>
                                üó∫Ô∏è {t.btn_map}
                            </button>
                            {/* CSV Export */}
                            <a href={`${API_BASE}/export/csv/${sat.norad_id}`} download style={{
                                background: 'transparent',
                                border: '1px solid #00ff88', color: '#00ff88',
                                padding: '4px 8px', borderRadius: '4px', cursor: 'pointer', fontSize: '0.8rem',
                                textDecoration: 'none', display: 'inline-flex', alignItems: 'center'
                            }}>
                                üìä {t.btn_csv}
                            </a>
                            {/* PDF Export */}
                            <a href={`${API_BASE}/export/pdf/${sat.norad_id}`} download style={{
                                background: 'transparent',
                                border: '1px solid #bc13fe', color: '#bc13fe',
                                padding: '4px 8px', borderRadius: '4px', cursor: 'pointer', fontSize: '0.8rem',
                                textDecoration: 'none', display: 'inline-flex', alignItems: 'center'
                            }}>
                                üìÑ {t.btn_pdf}
                            </a>
                        </div>
                    </div>

                    {/* Collision Alert Box */}
                    {showWarning && (
                        <div style={{
                            background: 'rgba(255, 0, 85, 0.15)',
                            border: `1px solid ${warningColor}`,
                            padding: '1rem',
                            borderRadius: '8px',
                            marginBottom: '1rem',
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '0.5rem'
                        }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', color: warningColor, fontWeight: 'bold', fontSize: '1.1rem' }}>
                                <span>‚ö†</span> <span>{t.det_warn}</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.9rem', color: '#ffcccb' }}>
                                <span>{t.det_prob}: {(sat.collision_probability || 0).toFixed(1)}%</span>
                                <span>{t.det_dist}: {sat.close_approach_dist || '?'} km</span>
                            </div>
                            <div style={{ fontSize: '0.8rem', color: '#aaa' }}>{t.det_time}: {sat.close_approach_time}</div>
                        </div>
                    )}

                    <div className="detail-grid">
                        <div className="detail-item"><label>{t.lbl_alt}</label><value>{sat.altitude_km} km</value></div>
                        <div className="detail-item"><label>{t.lbl_vel}</label><value>{sat.velocity_kms} km/s</value></div>
                        <div className="detail-item"><label>{t.lbl_inc}</label><value>{sat.inclination_deg}¬∞</value></div>
                        <div className="detail-item"><label>{t.lbl_per}</label><value>{sat.period_min} min</value></div>
                        <div className="detail-item"><label>{t.lbl_lat}</label><value>{sat.latitude ? sat.latitude : '--'}¬∞</value></div>
                        <div className="detail-item"><label>{t.lbl_lon}</label><value>{sat.longitude ? sat.longitude : '--'}¬∞</value></div>
                        <div className="detail-item" style={{ border: '1px solid #333', background: 'rgba(255,100,0,0.1)' }}>
                            <label>Risk Probability</label>
                            <value style={{ color: sat.collision_probability > 0 ? '#ffaa00' : '#00ff88' }}>
                                {sat.collision_probability}%
                            </value>
                        </div>
                    </div>
                </div>
            )
        }

        function OrbitViz({ selectedSat }) {
            const mountRef = useRef(null);
            const sceneRef = useRef(null);
            const earthRef = useRef(null);
            const satMeshRef = useRef(null);
            const curveRef = useRef(null);
            const progressRef = useRef(0); // 0 to 1 for animation

            useEffect(() => {
                if (!mountRef.current) return;

                // Init Scene
                const scene = new THREE.Scene();
                sceneRef.current = scene;

                const camera = new THREE.PerspectiveCamera(50, mountRef.current.clientWidth / mountRef.current.clientHeight, 0.1, 10000);
                const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                renderer.setSize(mountRef.current.clientWidth, mountRef.current.clientHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                mountRef.current.innerHTML = '';
                mountRef.current.appendChild(renderer.domElement);

                // --- EARTH ---
                const earthGroup = new THREE.Group();
                scene.add(earthGroup);
                earthRef.current = earthGroup;

                // 1. Ocean Base (Solid Blue)
                const geometry = new THREE.SphereGeometry(5, 64, 64);
                const material = new THREE.MeshPhongMaterial({
                    color: 0x0f1e3d,
                    emissive: 0x051020,
                    specular: 0x111111,
                    shininess: 25,
                    flatShading: false
                });
                const earth = new THREE.Mesh(geometry, material);
                earthGroup.add(earth);

                // 2. Wireframe Overlay
                const wireGeo = new THREE.WireframeGeometry(geometry);
                const wireMat = new THREE.LineBasicMaterial({ color: 0x3a5a8c, transparent: true, opacity: 0.1 });
                const wireglobe = new THREE.LineSegments(wireGeo, wireMat);
                earthGroup.add(wireglobe);

                // 3. Atmosphere Glow
                const atmoGeo = new THREE.SphereGeometry(5.2, 64, 64);
                const atmoMat = new THREE.MeshPhongMaterial({
                    color: 0x4facfe,
                    transparent: true,
                    opacity: 0.15,
                    side: THREE.BackSide,
                    blending: THREE.AdditiveBlending
                });
                const atmosphere = new THREE.Mesh(atmoGeo, atmoMat);
                scene.add(atmosphere);

                // --- SATELLITE MARKER ---
                const satGroup = new THREE.Group();
                // Body
                const bodyGeo = new THREE.BoxGeometry(0.4, 0.4, 0.4);
                const bodyMat = new THREE.MeshStandardMaterial({ color: 0xffd700, roughness: 0.3, metalness: 0.8 });
                const body = new THREE.Mesh(bodyGeo, bodyMat);
                satGroup.add(body);
                // Panels
                const panelGeo = new THREE.BoxGeometry(1.5, 0.05, 0.5);
                const panelMat = new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.5, metalness: 0.5 });
                const panel1 = new THREE.Mesh(panelGeo, panelMat);
                const panel2 = new THREE.Mesh(panelGeo, panelMat);
                panel2.rotation.y = Math.PI / 2;
                satGroup.add(panel1);
                satGroup.add(panel2);

                satGroup.visible = false;
                scene.add(satGroup);
                satMeshRef.current = satGroup;

                // Lighting
                const sunLight = new THREE.DirectionalLight(0xffffff, 2);
                sunLight.position.set(20, 10, 10);
                scene.add(sunLight);
                const ambientLight = new THREE.AmbientLight(0x404040);
                scene.add(ambientLight);

                camera.position.z = 18;

                // Animation Loop
                let reqId;
                const animate = () => {
                    reqId = requestAnimationFrame(animate);

                    // Earth Rotation
                    if (earthRef.current) earthRef.current.rotation.y += 0.0005;

                    // Satellite Movement along path
                    if (curveRef.current && satMeshRef.current && satMeshRef.current.visible) {
                        progressRef.current += 0.0005; // Speed factor
                        if (progressRef.current > 1) progressRef.current = 0;

                        const point = curveRef.current.getPoint(progressRef.current);
                        satMeshRef.current.position.copy(point);
                        satMeshRef.current.lookAt(0, 0, 0);
                    }

                    if (renderer && scene && camera) {
                        renderer.render(scene, camera);
                    }
                };
                animate();

                const handleResize = () => { if (!mountRef.current) return; renderer.setSize(mountRef.current.clientWidth, mountRef.current.clientHeight); camera.aspect = mountRef.current.clientWidth / mountRef.current.clientHeight; camera.updateProjectionMatrix(); };
                window.addEventListener('resize', handleResize);

                // Cleanup to prevent WebGL context loss and crashes
                return () => {
                    window.removeEventListener('resize', handleResize);
                    cancelAnimationFrame(reqId);
                    if (mountRef.current) mountRef.current.innerHTML = '';
                    renderer.dispose();
                };
            }, []);

            // Visual Trajectory Logic
            useEffect(() => {
                if (!selectedSat || !sceneRef.current) return;

                // Clean old
                const oldLine = sceneRef.current.getObjectByName("trajectoryLine");
                if (oldLine) sceneRef.current.remove(oldLine);
                if (satMeshRef.current) satMeshRef.current.visible = false;
                curveRef.current = null;
                progressRef.current = 0;

                // Fetch new trajectory
                fetchWithRetry(`${API_BASE}/propagate/${selectedSat.norad_id}`, {}, 2, 15000)
                    .then(data => {
                        if (data && data.trajectory && data.trajectory.length > 0) {
                            const points = data.trajectory.map(p => {
                                const scale = 5 / 6371;
                                return new THREE.Vector3(p.x * scale, p.y * scale, p.z * scale);
                            });

                            // Close loop for continuous animation if it's a full orbit? 
                            // Propagate endpoint gives 90 mins (approx 1 orbit). 
                            // Let's assume it's an open curve for now.

                            const curve = new THREE.CatmullRomCurve3(points);
                            curveRef.current = curve;

                            // Using Points for a clearly visible "dotted" line in 3D
                            const pGeometry = new THREE.BufferGeometry().setFromPoints(curve.getPoints(200));
                            const pMaterial = new THREE.PointsMaterial({
                                color: 0x00f3ff,
                                size: 0.15,
                                transparent: true,
                                opacity: 0.7,
                                sizeAttenuation: true
                            });
                            const pointsCloud = new THREE.Points(pGeometry, pMaterial);
                            pointsCloud.name = "trajectoryLine";
                            sceneRef.current.add(pointsCloud);

                            if (satMeshRef.current) {
                                satMeshRef.current.visible = true;
                            }
                        }
                    })
                    .catch(err => console.error("Error fetching path:", err));

            }, [selectedSat]);

            return <div className="viz-wrapper"><div className="viz-container"><div ref={mountRef} style={{ width: '100%', height: '100%' }}></div></div></div>;
        }

        function ForecastView({ t, selectedSat }) {
            const [analytics, setAnalytics] = useState(null);
            const [globalStats, setGlobalStats] = useState(null);

            useEffect(() => {
                fetchWithRetry(`${API_BASE}/stats`, {}, 2, 8000)
                    .then(data => {
                        if (data && typeof data === 'object') {
                            setGlobalStats(data);
                        }
                    })
                    .catch(err => {
                        console.error("Stats fetch failed:", err);
                        // Set fallback stats
                        setGlobalStats({
                            total_tracked: 0,
                            high_risk_count: 0,
                            system_health: "Unknown",
                            last_update: new Date().toISOString()
                        });
                    });
            }, []);

            useEffect(() => {
                if (!selectedSat) return;
                fetchWithRetry(`${API_BASE}/analytics/${selectedSat.norad_id}`, {}, 2, 10000)
                    .then(data => {
                        if (data && typeof data === 'object') {
                            setAnalytics(data);
                        }
                    })
                    .catch(err => {
                        console.error("Analytics fetch failed:", err);
                        setAnalytics(null);
                    });
            }, [selectedSat]);

            return (
                <div className="section-container" style={{ maxWidth: '1100px' }}>
                    <h2 style={{ fontFamily: 'Cinzel', color: 'white', marginBottom: '2rem' }}>{t.f_title}</h2>

                    <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '2rem' }}>

                        {/* Selected Sat Trend */}
                        <div className="info-card">
                            <h3>{t.f_risk_trend} {analytics && `: ${selectedSat.name}`}</h3>
                            {analytics ? (
                                <React.Fragment>
                                    <div style={{ height: '200px', display: 'flex', alignItems: 'end', gap: '8px', padding: '1rem 0', borderBottom: '1px solid #333' }}>
                                        {analytics.trend_data.map((p, i) => (
                                            <div key={i} style={{
                                                flex: 1,
                                                background: `linear-gradient(to top, rgba(0, 243, 255, 0.4), var(--primary-glow))`,
                                                height: `${p.risk_score}%`,
                                                borderRadius: '4px 4px 0 0',
                                                position: 'relative'
                                            }}>
                                                <div style={{ position: 'absolute', top: '-25px', left: '50%', transform: 'translateX(-50%)', fontSize: '0.6rem', color: '#00f3ff' }}>
                                                    {p.risk_score}%
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '0.5rem', color: '#666', fontSize: '0.7rem' }}>
                                        <span>7 Days Ago</span>
                                        <span>Today</span>
                                    </div>
                                    <div style={{ marginTop: '2rem', background: 'rgba(0,0,0,0.3)', padding: '1.5rem', borderRadius: '12px', border: '1px solid #333' }}>
                                        <h4 style={{ margin: '0 0 1rem 0', color: '#bc13fe' }}>{t.f_neural_summary}</h4>
                                        <p style={{ margin: 0, color: '#aaa', fontSize: '0.9rem', lineHeight: 1.6 }}>{analytics.forecast_summary}</p>
                                        <div style={{ display: 'flex', gap: '2rem', marginTop: '1.5rem' }}>
                                            <div>
                                                <div style={{ fontSize: '0.7rem', color: '#666', textTransform: 'uppercase' }}>{t.f_stability}</div>
                                                <div style={{ fontSize: '1.2rem', color: '#00ff88', fontWeight: 'bold' }}>{analytics.stability_index}%</div>
                                            </div>
                                            <div>
                                                <div style={{ fontSize: '0.7rem', color: '#666', textTransform: 'uppercase' }}>{t.f_avg_alt}</div>
                                                <div style={{ fontSize: '1.2rem', color: '#fff' }}>{analytics.avg_altitude} km</div>
                                            </div>
                                        </div>
                                    </div>
                                </React.Fragment>
                            ) : (
                                <div style={{ height: '300px', display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center', color: '#444' }}>
                                    <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üìä</div>
                                    <p>{t.f_empty}</p>
                                </div>
                            )}
                        </div>

                        {/* Global Stats */}
                        <div className="info-card">
                            <h3>{t.s_ready}</h3>
                            {globalStats ? (
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>
                                    <div style={{ background: 'rgba(255,255,255,0.03)', padding: '1rem', borderRadius: '8px' }}>
                                        <div style={{ color: '#aaa', fontSize: '0.8rem' }}>{t.m_obj}</div>
                                        <div style={{ fontSize: '1.8rem', color: '#fff', fontFamily: 'Cinzel' }}>{globalStats.total_tracked.toLocaleString()}</div>
                                    </div>
                                    <div style={{ background: 'rgba(255,0,85,0.05)', padding: '1rem', borderRadius: '8px', borderLeft: '3px solid #ff0055' }}>
                                        <div style={{ color: '#ffb3c5', fontSize: '0.8rem' }}>{t.m_risk} (24h)</div>
                                        <div style={{ fontSize: '1.8rem', color: '#ff0055', fontFamily: 'Cinzel' }}>{globalStats.high_risk_count}</div>
                                    </div>
                                    <div style={{ background: 'rgba(0,255,136,0.05)', padding: '1rem', borderRadius: '8px', borderLeft: '3px solid #00ff88' }}>
                                        <div style={{ color: '#b3ffdd', fontSize: '0.8rem' }}>{t.m_status}</div>
                                        <div style={{ fontSize: '1.1rem', color: '#00ff88' }}>‚óè {globalStats.system_health}</div>
                                    </div>
                                    <p style={{ fontSize: '0.7rem', color: '#444', marginTop: '1rem' }}>{t.m_status_update}: {new Date(globalStats.last_update).toLocaleTimeString()}</p>
                                </div>
                            ) : <div>Loading Stats...</div>}
                        </div>
                    </div>
                </div>
            );
        }

        function WorldMapView({ t, selectedSat }) {
            const [groundTrack, setGroundTrack] = useState([]);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if (!selectedSat) return;
                setLoading(true);
                // Fetch 180 minutes of propagation for ground track (approx 2 orbits)
                fetchWithRetry(`${API_BASE}/propagate/${selectedSat.norad_id}?minutes=180&steps=200`, {}, 2, 15000)
                    .then(data => {
                        setGroundTrack((data && data.trajectory) ? data.trajectory : []);
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error("Map propagation failed:", err);
                        setGroundTrack([]);
                        setLoading(false);
                    });
            }, [selectedSat]);

            const getPos = (lat, lon) => {
                const x = ((lon + 180) / 360) * 100;
                const y = ((90 - lat) / 180) * 100;
                return { x, y }; // Return numbers for SVG viewBox
            };

            let markerStyle = {};
            let hasSat = false;

            if (selectedSat && selectedSat.latitude != null && selectedSat.longitude != null) {
                hasSat = true;
                const pos = getPos(selectedSat.latitude, selectedSat.longitude);
                markerStyle = {
                    position: 'absolute',
                    left: `${pos.x}%`,
                    top: `${pos.y}%`,
                    width: '16px', height: '16px',
                    background: selectedSat.risk_level === 'High' ? '#ff0055' : '#00f3ff',
                    borderRadius: '50%',
                    transform: 'translate(-50%, -50%)',
                    boxShadow: `0 0 20px ${selectedSat.risk_level === 'High' ? '#ff0055' : '#00f3ff'}`,
                    border: '2px solid white',
                    animation: 'pulse 2s infinite',
                    zIndex: 20
                };
            }

            return (
                <div className="section-container" style={{ maxWidth: '1200px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                        <h2 style={{ fontFamily: 'Cinzel', color: 'white', margin: 0 }}>{t.m_title}</h2>
                        {selectedSat && <div style={{ color: '#00f3ff', fontSize: '0.9rem' }}>{t.m_tracking}: {selectedSat.name} (#{selectedSat.norad_id})</div>}
                    </div>

                    <div style={{
                        width: '100%', height: '600px', background: '#05070a',
                        border: '1px solid #333', borderRadius: '12px',
                        position: 'relative', overflow: 'hidden'
                    }}>
                        {/* Map Background Layer - Only this is filtered */}
                        <div style={{
                            position: 'absolute', top: 0, left: 0, width: '100%', height: '100%',
                            backgroundImage: 'url("https://upload.wikimedia.org/wikipedia/commons/e/ec/World_map_blank_without_borders.svg")',
                            backgroundSize: '100% 100%',
                            backgroundPosition: 'center',
                            filter: 'invert(1) hue-rotate(180deg) brightness(0.6)'
                        }}></div>

                        <style>{`
                            @keyframes pulse {
                                0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                                50% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.5; }
                                100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                            }
                        `}</style>

                        {/* Ground Track Path - High Visibility Layer */}
                        <svg viewBox="0 0 100 100" preserveAspectRatio="none" style={{ position: 'absolute', top: 0, left: 0, width: '100%', height: '100%', pointerEvents: 'none', zIndex: 15 }}>
                            {groundTrack.length > 1 && (
                                <path
                                    d={groundTrack.reduce((acc, p, i) => {
                                        const pos = getPos(p.lat, p.lon);
                                        // Handle wrap-around discontinuities
                                        if (i > 0) {
                                            const prevP = groundTrack[i - 1];
                                            if (Math.abs(p.lon - prevP.lon) > 180) {
                                                return acc + ` M ${pos.x} ${pos.y}`;
                                            }
                                        }
                                        return acc + (i === 0 ? `M ${pos.x} ${pos.y}` : ` L ${pos.x} ${pos.y}`);
                                    }, "")}
                                    fill="none"
                                    stroke="#00ffff"
                                    strokeWidth="0.8"
                                    strokeDasharray="1.5,1.5"
                                />
                            )}
                        </svg>

                        {hasSat && (
                            <React.Fragment>
                                <div style={markerStyle}></div>
                                <div style={{
                                    position: 'absolute',
                                    left: markerStyle.left,
                                    top: `calc(${markerStyle.top} + 20px)`,
                                    transform: 'translateX(-50%)',
                                    background: 'rgba(0,0,0,0.9)',
                                    padding: '5px 12px',
                                    borderRadius: '6px',
                                    border: '1px solid #444',
                                    whiteSpace: 'nowrap',
                                    zIndex: 10,
                                    fontSize: '0.8rem',
                                    boxShadow: '0 4px 15px rgba(0,0,0,0.5)'
                                }}>
                                    <div style={{ color: '#fff', fontWeight: 'bold' }}>{selectedSat.name}</div>
                                    <div style={{ color: '#00f3ff' }}>{selectedSat.latitude.toFixed(2)}¬∞, {selectedSat.longitude.toFixed(2)}¬∞</div>
                                </div>
                            </React.Fragment>
                        )}

                        <div style={{ position: 'absolute', bottom: '20px', left: '20px', background: 'rgba(0,0,0,0.85)', padding: '1rem', borderRadius: '12px', border: '1px solid #333' }}>
                            <h4 style={{ margin: '0 0 0.5rem 0', color: '#00f3ff', fontFamily: 'Cinzel' }}>{t.m_intel}</h4>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.5rem 1.5rem', fontSize: '0.8rem' }}>
                                <span style={{ color: '#aaa' }}>{t.m_obj}:</span> <span style={{ color: '#fff' }}>27,432</span>
                                <span style={{ color: '#aaa' }}>{t.m_risk}:</span> <span style={{ color: '#ff0055' }}>142</span>
                                <span style={{ color: '#aaa' }}>{t.m_status}:</span> <span style={{ color: '#00ff88' }}>{t.m_op}</span>
                            </div>
                        </div>

                        {loading && <div style={{ position: 'absolute', top: '20px', right: '20px', background: 'rgba(0,0,0,0.7)', padding: '5px 15px', borderRadius: '20px', color: '#00f3ff', fontSize: '0.8rem' }}>{t.m_calc}</div>}
                    </div>
                </div>
            )
        }

        const HISTORY_KEY = "bellatrix_sat_history";

        function CalculatorView({ t, selectedSat, setSelectedSat, showOnMap, showToast }) {
            const [satellites, setSatellites] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchId, setSearchId] = useState("");
            const [searchResults, setSearchResults] = useState([]);

            // Load from localStorage on mount, then fetch defaults
            useEffect(() => {
                const saved = localStorage.getItem(HISTORY_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.length > 0) {
                            setSatellites(parsed);
                            setLoading(false);
                            return;
                        }
                    } catch (e) { /* ignore corrupt cache */ }
                }
                fetchWithRetry(`${API_BASE}/satellites`)
                    .then(data => { 
                        if (Array.isArray(data)) {
                            setSatellites(data); 
                        } else {
                            // Fallback to empty array if invalid response
                            setSatellites([]);
                        }
                        setLoading(false); 
                    })
                    .catch(err => { 
                        console.error("Failed to fetch satellites:", err); 
                        // Fallback to empty array on error
                        setSatellites([]);
                        setLoading(false);
                        showToast && showToast("Failed to load satellites. Using cached data.", 'info');
                    });
            }, []);

            // Save to localStorage whenever satellites list changes
            useEffect(() => {
                if (satellites.length > 0) {
                    localStorage.setItem(HISTORY_KEY, JSON.stringify(satellites));
                }
            }, [satellites]);

            const clearHistory = () => {
                localStorage.removeItem(HISTORY_KEY);
                setSatellites([]);
                setLoading(true);
                fetchWithRetry(`${API_BASE}/satellites`)
                    .then(data => { 
                        if (Array.isArray(data)) {
                            setSatellites(data); 
                        } else {
                            setSatellites([]);
                        }
                        setLoading(false); 
                    })
                    .catch(() => {
                        setSatellites([]);
                        setLoading(false);
                    });
            };

            const performSearch = () => {
                const q = (searchId || "").trim();
                if (!q) {
                    return;
                }

                // 1) –ë—ã—Å—Ç—Ä—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º —Å–ø—É—Ç–Ω–∏–∫–∞–º
                const lowerQ = q.toLowerCase();
                const localMatches = satellites.filter((s) => {
                    return (
                        (s.norad_id && s.norad_id.toString() === q) ||
                        (s.name && s.name.toLowerCase().includes(lowerQ))
                    );
                });

                if (localMatches.length > 0) {
                    // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Å–ø–∏—Å–∫–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—ã–¥–µ–ª—è–µ–º
                    const found = localMatches[0];
                    setSelectedSat(found);
                    return;
                }

                // 2) –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –ø—Ä–æ–±—É–µ–º –±—ç–∫–µ–Ω–¥‚Äë–ø–æ–∏—Å–∫
                setLoading(true);
                setSearchResults([]); // Clear previous

                fetchWithRetry(`${API_BASE}/search?q=${encodeURIComponent(q)}`, {}, 2, 8000)
                    .then(results => {
                        setLoading(false);
                        if (!Array.isArray(results) || results.length === 0) {
                            showToast(t.err_not_found, 'error');
                        } else if (results.length === 1) {
                            // Perfect match, add directly
                            addToDashboard(results[0].norad_id);
                        } else {
                            // Multiple matches, show list
                            setSearchResults(results);
                        }
                    })
                    .catch(err => {
                        console.error("Search error:", err);
                        setLoading(false);
                        showToast(t.err_search_fail, 'error');
                    });
            };

            const addToDashboard = (id) => {
                setLoading(true);
                setSearchResults([]); // Hide list
                fetchWithRetry(`${API_BASE}/satellite/${id}/details`, {}, 2, 8000)
                    .then(newSat => {
                        if (!newSat || !newSat.norad_id) {
                            throw new Error("Invalid satellite data");
                        }
                        // Check if already exists
                        if (!satellites.find(s => s.norad_id === newSat.norad_id)) {
                            setSatellites(prev => [...prev, newSat]);
                        }
                        setSelectedSat(newSat); // This updates App state
                        setSearchId("");
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error("Details fetch error:", err);
                        showToast(t.err_details_fail, 'error');
                        setLoading(false);
                    });
            };

            return (
                <div className="calculator-layout">
                    {/* Search Row - –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–≤–µ—Ä—Ö—É */}
                    <div style={{ gridArea: 'search', display: 'flex', flexDirection: 'column', gap: '0.5rem', flexShrink: 0, position: 'relative' }}>
                        <div style={{ display: 'flex', gap: '0.5rem', position: 'relative', zIndex: 10 }}>
                            <input
                                type="text"
                                placeholder={t.calc_placeholder}
                                value={searchId}
                                onChange={(e) => setSearchId(e.target.value)}
                                onKeyDown={(e) => e.key === 'Enter' && performSearch()}
                                style={{
                                    flex: 1, padding: '0.8rem', background: 'rgba(255,255,255,0.05)',
                                    border: '1px solid var(--card-border)', color: 'white', borderRadius: '8px'
                                }}
                            />
                            <button className="cta-button" style={{ padding: '0 1rem', fontSize: '0.8rem' }} onClick={performSearch}>
                                {t.calc_add}
                            </button>
                            
                            {/* Search Results Dropdown - –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–æ–∏—Å–∫–∞ */}
                            {searchResults.length > 0 && (
                                <div style={{
                                    position: 'absolute', top: 'calc(100% + 5px)', left: 0, right: 0, zIndex: 1000,
                                    background: '#0a0f18', border: '1px solid #333', borderRadius: '8px',
                                    maxHeight: '200px', overflowY: 'auto', boxShadow: '0 4px 20px rgba(0,0,0,0.5)'
                                }}>
                                    {searchResults.map(res => (
                                        <div key={res.norad_id}
                                            onClick={() => addToDashboard(res.norad_id)}
                                            style={{ padding: '0.8rem', borderBottom: '1px solid #222', cursor: 'pointer', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}
                                            onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.1)'}
                                            onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}>
                                            <span style={{ color: 'white' }}>{res.name}</span>
                                            <span style={{ color: '#666', fontSize: '0.8rem' }}>#{res.norad_id}</span>
                                        </div>
                                    ))}
                                    <div style={{ padding: '0.5rem', textAlign: 'center', fontSize: '0.8rem', color: '#888', cursor: 'pointer' }} onClick={() => setSearchResults([])}>
                                        Cancel
                                    </div>
                                </div>
                            )}
                        </div>
                        {/* Clear History Button */}
                        {satellites.length > 0 && (
                            <button onClick={clearHistory} style={{
                                background: 'transparent', border: '1px solid #333', color: '#666',
                                padding: '0.4rem 0.8rem', borderRadius: '6px', cursor: 'pointer',
                                fontSize: '0.75rem', alignSelf: 'flex-start'
                            }}>
                                üóë {t.btn_clear}
                            </button>
                        )}
                    </div>

                    {/* List of satellites */}
                    <div className="dashboard-grid">
                        {loading ? <div className="state-msg">{t.calc_init}</div> :
                            satellites.map(sat => (
                                <SatelliteCard key={sat.norad_id} sat={sat} onClick={setSelectedSat} t={t} />
                            ))
                        }
                    </div>

                    <DetailPanel sat={selectedSat} t={t} onShowMap={() => showOnMap(selectedSat)} />

                    <OrbitViz selectedSat={selectedSat} t={t} />
                </div>
            );
        }

        // --- MAIN APP ---
        function Sitemap({ t }) {
            const linkStyle = {
                color: '#aaa',
                textDecoration: 'none',
                display: 'block',
                padding: '0.25rem 0',
                transition: 'color 0.2s ease',
                cursor: 'default'
            };
            
            return (
                <div style={{ padding: '4rem 2rem', background: '#05070a', borderTop: '1px solid #111', color: '#666', fontSize: '0.8rem' }}>
                    <div style={{ maxWidth: '1200px', margin: '0 auto', display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '2rem' }}>
                        <div>
                            <h4 style={{ color: '#fff', marginBottom: '1rem', fontFamily: 'Cinzel' }}>{t.s_nav}</h4>
                            <ul style={{ listStyle: 'none', padding: 0 }}>
                                <li style={linkStyle}>{t.nav_home}</li>
                                <li style={linkStyle}>{t.s_calc}</li>
                                <li style={linkStyle}>{t.s_map}</li>
                                <li style={linkStyle}>{t.s_forecast}</li>
                                <li style={linkStyle}>{t.s_guide}</li>
                            </ul>
                        </div>
                        <div>
                            <h4 style={{ color: '#fff', marginBottom: '1rem', fontFamily: 'Cinzel' }}>{t.s_intel}</h4>
                            <ul style={{ listStyle: 'none', padding: 0 }}>
                                <li style={linkStyle}>{t.s_prop}</li>
                                <li style={linkStyle}>{t.s_risk}</li>
                                <li style={linkStyle}>{t.s_ground}</li>
                                <li style={linkStyle}>{t.s_ready}</li>
                            </ul>
                        </div>
                        <div>
                            <h4 style={{ color: '#fff', marginBottom: '1rem', fontFamily: 'Cinzel' }}>{t.s_legal}</h4>
                            <ul style={{ listStyle: 'none', padding: 0 }}>
                                <li style={linkStyle}>{t.s_terms}</li>
                                <li style={linkStyle}>{t.s_policy}</li>
                                <li style={linkStyle}>NORAD Catalog</li>
                            </ul>
                        </div>
                        <div>
                            <h4 style={{ color: '#00f3ff', marginBottom: '1rem', fontFamily: 'Cinzel' }}>BELLATRIX V4.0</h4>
                            <p style={{ color: '#aaa', lineHeight: '1.6' }}>{t.s_platform}</p>
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const [currentView, setView] = useState('home');
            const [lang, setLang] = useState('en');
            const [selectedSat, setSelectedSat] = useState(null);
            const [showToast, ToastContainer] = useToast();

            // Handler to go to map with a specific satellite
            const showOnMap = (sat) => {
                setSelectedSat(sat);
                setView('map');
            };

            return (
                <React.Fragment>
                    <StarBackground />
                    <NavBar currentView={currentView} setView={setView} lang={lang} setLang={setLang} />
                    {currentView === 'home' && <HomeView setView={setView} t={TRANSLATIONS[lang]} />}
                    {currentView === 'guide' && <ErrorBoundary><GuideView t={TRANSLATIONS[lang]} /></ErrorBoundary>}
                    {currentView === 'map' && <ErrorBoundary><WorldMapView t={TRANSLATIONS[lang]} selectedSat={selectedSat} /></ErrorBoundary>}
                    {currentView === 'forecast' && <ErrorBoundary><ForecastView t={TRANSLATIONS[lang]} selectedSat={selectedSat} /></ErrorBoundary>}
                    {currentView === 'calc' && <ErrorBoundary><CalculatorView t={TRANSLATIONS[lang]} selectedSat={selectedSat} setSelectedSat={setSelectedSat} showOnMap={showOnMap} showToast={showToast} /></ErrorBoundary>}
                    <Sitemap t={TRANSLATIONS[lang]} />
                    <ToastContainer />
                </React.Fragment>
            );
        }

        // Initialize React App with error handling
        try {
            const rootElement = document.getElementById('root');
            if (!rootElement) {
                throw new Error('Root element not found');
            }
            const root = ReactDOM.createRoot(rootElement);
            root.render(<App />);
        } catch (error) {
            console.error('Failed to initialize React app:', error);
            document.body.innerHTML = `
                <div style="padding: 2rem; color: #ff0055; text-align: center; background: #05070a; min-height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                    <h2 style="font-family: 'Cinzel', serif;">System Error</h2>
                    <p>Failed to initialize application. Please refresh the page.</p>
                    <pre style="background: #111; padding: 1rem; border-radius: 8px; text-align: left; max-width: 600px; overflow: auto;">${error.toString()}</pre>
                    <button onclick="window.location.reload()" style="margin-top: 1rem; padding: 0.5rem 1.5rem; background: #00f3ff; color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">Reload Page</button>
                </div>
            `;
        }
    </script>
</body>

</html>